<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Tracker - Your Nutrition Companion</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .nav-btn.active {
            background: #4CAF50;
            color: white;
        }

        .content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }

        .card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(76, 175, 80, 0.3);
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger {
            background: #f44336;
            box-shadow: 0 4px 6px rgba(244, 67, 54, 0.3);
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-secondary {
            background: #2196F3;
            box-shadow: 0 4px 6px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .progress-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .macro-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .macro-card h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .macro-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .macro-goal {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .food-log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .food-log-item h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .food-log-item p {
            color: #666;
            font-size: 14px;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #da190b;
        }

        .chat-container {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
        }

        .chat-message.user {
            background: #4CAF50;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid #ddd;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
        }

        .toggle-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #4CAF50;
            background: white;
            color: #4CAF50;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .toggle-btn.active {
            background: #4CAF50;
            color: white;
        }

        .meal-card {
            background: white;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .meal-card.completed {
            opacity: 0.6;
            border-left-color: #999;
        }

        .meal-card.unassigned {
            border-left-color: #FF9800;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .meal-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .meal-time {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .meal-date-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .generated-meals {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .week-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .day-column {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            min-height: 200px;
        }

        .day-column h4 {
            color: #4CAF50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }

        .mini-meal-card {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .mini-meal-card:hover {
            transform: translateX(5px);
        }

        .mini-meal-card.completed {
            opacity: 0.6;
            border-left-color: #999;
        }

        .upcoming-day-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #4CAF50;
        }

        .upcoming-day-name {
            font-weight: 600;
            color: #333;
            min-width: 100px;
        }

        .upcoming-macros {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }

        .upcoming-macro-item {
            color: #666;
        }

        .upcoming-macro-item strong {
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .serving-input {
            width: 80px;
            padding: 6px;
            border: 2px solid #4CAF50;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            font-weight: 600;
        }

        .serving-label {
            display: inline-block;
            margin-left: 8px;
            color: #666;
            font-size: 14px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #4CAF50;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f0f9f0;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .search-result-brand {
            font-size: 12px;
            color: #4CAF50;
            margin-bottom: 4px;
        }

        .search-result-macros {
            font-size: 12px;
            color: #666;
        }

        .search-loading {
            padding: 12px;
            text-align: center;
            color: #666;
        }

        .auth-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-container.show {
            display: flex;
        }

        .auth-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .auth-box h2 {
            color: #4CAF50;
            margin-bottom: 10px;
            text-align: center;
        }

        .auth-box p {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-toggle a {
            color: #4CAF50;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-button {
            background: white;
            border: 2px solid #4CAF50;
            color: #4CAF50;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-button:hover {
            background: #f0f9f0;
        }

        .user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            margin-top: 5px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 20px;
            color: #333;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .user-dropdown-item:hover {
            background: #f0f9f0;
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
            color: #f44336;
            border-radius: 0 0 8px 8px;
        }

        .sync-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .sync-status.synced {
            background: #C8E6C9;
            color: #2E7D32;
        }

        .sync-status.syncing {
            background: #FFF9C4;
            color: #F57F17;
        }

        .sync-status.offline {
            background: #FFCDD2;
            color: #C62828;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .nav {
                flex-direction: column;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .macro-grid {
                grid-template-columns: 1fr 1fr;
            }

            .generated-meals {
                grid-template-columns: 1fr;
            }

            .week-view {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçé Food Tracker</h1>
            <p>Your AI-Powered Nutrition Companion</p>
            <div style="margin-top: 15px;">
                <div id="user-section" style="display: none;">
                    <div class="user-menu">
                        <button class="user-button" onclick="toggleUserMenu()">
                            <span id="user-display-name">User</span>
                            <span>‚ñº</span>
                        </button>
                        <div id="user-dropdown" class="user-dropdown">
                            <div class="user-dropdown-item" style="font-size: 12px; color: #999; cursor: default;" id="user-email-display">email@example.com</div>
                            <div class="user-dropdown-item" onclick="logout()">Logout</div>
                        </div>
                    </div>
                    <span id="sync-status" class="sync-status synced">‚úì Synced</span>
                </div>
                <button id="login-button" class="btn" onclick="showAuth()" style="display: inline-block;">Login / Sign Up</button>
            </div>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="showSection('profile')">Profile</button>
            <button class="nav-btn" onclick="showSection('mealplan')">AI Meal Planner</button>
            <button class="nav-btn" onclick="showSection('weekview')">Week View</button>
            <button class="nav-btn" onclick="showSection('foodlog')">Food Log</button>
            <button class="nav-btn" onclick="showSection('shopping')">Shopping List</button>
        </div>

        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin-bottom: 0;">Daily Progress</h2>
                    
                    <div style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px 15px; border-radius: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <button onclick="changeViewDate(-1)" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #4CAF50; padding: 5px 10px;">‚Üê</button>
                        <input type="date" id="view-date" onchange="onDateChange()" style="border: 2px solid #4CAF50; padding: 8px 12px; border-radius: 8px; font-size: 14px; cursor: pointer;">
                        <button onclick="changeViewDate(1)" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #4CAF50; padding: 5px 10px;">‚Üí</button>
                        <button onclick="goToToday()" class="btn btn-sm" style="margin: 0;">Today</button>
                    </div>
                </div>
                
                <div id="date-label" style="text-align: center; color: #666; font-size: 14px; margin-bottom: 20px;"></div>
                
                <div class="card">
                    <div class="progress-container">
                        <div class="progress-label">
                            <span><strong>Calories</strong></span>
                            <span id="calories-text">0 / 2000 cal</span>
                        </div>
                        <div class="progress-bar">
                            <div id="calories-progress" class="progress-fill" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>

                <div class="macro-grid">
                    <div class="macro-card" style="border-left: 4px solid #FF9800;">
                        <h4>Carbs</h4>
                        <div class="macro-value">
                            <span id="carbs-actual" style="color: #FF9800;">0g</span>
                            <span id="carbs-planned" style="color: #FFB74D; opacity: 0.5;"> / 0g</span>
                        </div>
                        <div class="macro-goal" id="carbs-goal">Goal: 250g</div>
                        <div style="font-size: 11px; color: #999; margin-top: 4px;">
                            <span style="color: #FF9800;">‚óè</span> Eaten ¬∑ 
                            <span style="color: #FFB74D;">‚óã</span> Planned
                        </div>
                    </div>
                    <div class="macro-card" style="border-left: 4px solid #2196F3;">
                        <h4>Protein</h4>
                        <div class="macro-value">
                            <span id="protein-actual" style="color: #2196F3;">0g</span>
                            <span id="protein-planned" style="color: #64B5F6; opacity: 0.5;"> / 0g</span>
                        </div>
                        <div class="macro-goal" id="protein-goal">Goal: 150g</div>
                        <div style="font-size: 11px; color: #999; margin-top: 4px;">
                            <span style="color: #2196F3;">‚óè</span> Eaten ¬∑ 
                            <span style="color: #64B5F6;">‚óã</span> Planned
                        </div>
                    </div>
                    <div class="macro-card" style="border-left: 4px solid #F44336;">
                        <h4>Fat</h4>
                        <div class="macro-value">
                            <span id="fat-actual" style="color: #F44336;">0g</span>
                            <span id="fat-planned" style="color: #EF5350; opacity: 0.5;"> / 0g</span>
                        </div>
                        <div class="macro-goal" id="fat-goal">Goal: 67g</div>
                        <div style="font-size: 11px; color: #999; margin-top: 4px;">
                            <span style="color: #F44336;">‚óè</span> Eaten ¬∑ 
                            <span style="color: #EF5350;">‚óã</span> Planned
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Today's Meals</h3>
                    <div id="today-meals"></div>
                </div>

                <div class="card">
                    <h3>Next Few Days - Planned Macros</h3>
                    <div id="upcoming-macros"></div>
                </div>

                <div class="card">
                    <h3>Food Log</h3>
                    <div id="today-food-list"></div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profile" class="section">
                <h2 class="section-title">Profile Setup</h2>
                
                <div class="card">
                    <h3>Personal Information</h3>
                    <div class="input-group">
                        <label>Name</label>
                        <input type="text" id="user-name" placeholder="Your name">
                    </div>
                    
                    <div class="input-group">
                        <label>Gender</label>
                        <select id="user-gender">
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Age</label>
                        <input type="number" id="user-age" placeholder="e.g., 30" min="1" max="120">
                    </div>

                    <div class="toggle-container">
                        <button class="toggle-btn active" id="imperial-toggle" onclick="toggleUnits('imperial')">Imperial (lbs/in)</button>
                        <button class="toggle-btn" id="metric-toggle" onclick="toggleUnits('metric')">Metric (kg/cm)</button>
                    </div>

                    <div id="imperial-inputs">
                        <div class="input-group">
                            <label>Current Weight (lbs)</label>
                            <input type="number" id="weight-lbs" placeholder="e.g., 180" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Target Weight (lbs)</label>
                            <input type="number" id="target-weight-lbs" placeholder="e.g., 160" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Height</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="height-feet" placeholder="Feet" min="0" max="8" style="flex: 1;">
                                <input type="number" id="height-inches" placeholder="Inches" min="0" max="11" step="0.1" style="flex: 1;">
                            </div>
                        </div>
                    </div>

                    <div id="metric-inputs" style="display: none;">
                        <div class="input-group">
                            <label>Current Weight (kg)</label>
                            <input type="number" id="weight-kg" placeholder="e.g., 82" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Target Weight (kg)</label>
                            <input type="number" id="target-weight-kg" placeholder="e.g., 73" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Height (cm)</label>
                            <input type="number" id="height-cm" placeholder="e.g., 175" step="0.1">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Activity Level</label>
                        <select id="activity-level">
                            <option value="1.2">Sedentary (little or no exercise)</option>
                            <option value="1.375">Lightly active (1-3 days/week)</option>
                            <option value="1.55" selected>Moderately active (3-5 days/week)</option>
                            <option value="1.725">Very active (6-7 days/week)</option>
                            <option value="1.9">Extremely active (twice per day, intense)</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="calculateCalories()" style="width: 100%; margin-top: 10px;">Calculate My Calories</button>

                    <div id="calorie-results" style="display: none; margin-top: 20px; padding: 20px; background: #E8F5E9; border-radius: 10px;">
                        <h4 style="color: #4CAF50; margin-bottom: 15px;">üìä Your Calorie Calculation</h4>
                        <div style="margin-bottom: 10px;">
                            <strong>BMR (Basal Metabolic Rate):</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 4px;">Calories burned at rest</div>
                            <div id="bmr-result" style="font-size: 24px; color: #4CAF50; font-weight: bold; margin-top: 4px;">-</div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50;">
                            <strong>TDEE (Total Daily Energy Expenditure):</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 4px;">Calories burned per day (including activity)</div>
                            <div id="tdee-result" style="font-size: 28px; color: #2E7D32; font-weight: bold; margin-top: 4px;">-</div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px;">
                            <div style="font-size: 13px; color: #666; line-height: 1.6;">
                                üí° <strong>Tip:</strong> For weight loss, aim for 300-500 calories below your TDEE. For weight gain, aim for 300-500 above. For maintenance, match your TDEE.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Daily Goals</h3>
                    
                    <div class="input-group">
                        <label>Goal Type</label>
                        <select id="goal-type">
                            <option value="maintain">Maintain Weight</option>
                            <option value="cut">Weight Loss (Cut)</option>
                            <option value="bulk">Weight Gain (Bulk)</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="calculateSuggestedCalories()" style="width: 100%; margin-bottom: 15px;">Calculate Suggested Calories</button>

                    <div id="calorie-suggestions" style="display: none; margin-bottom: 20px; padding: 20px; background: #E8F5E9; border-radius: 10px;">
                        <h4 style="color: #4CAF50; margin-bottom: 15px;">üéØ Suggested Daily Calories</h4>
                        <div id="calorie-suggestion-content"></div>
                        <button class="btn btn-sm" onclick="applySuggestedCalories()" style="margin-top: 15px; width: 100%;">Apply This Calorie Goal</button>
                    </div>

                    <div class="input-group">
                        <label>Daily Calorie Goal</label>
                        <input type="number" id="daily-calories" placeholder="e.g., 2000" value="2000">
                    </div>

                    <button class="btn btn-secondary" onclick="calculateSuggestedMacros()" style="width: 100%; margin-bottom: 15px;">Calculate Suggested Macros</button>

                    <div id="macro-suggestions" style="display: none; margin-bottom: 20px; padding: 20px; background: #E3F2FD; border-radius: 10px;">
                        <h4 style="color: #2196F3; margin-bottom: 15px;">üìä Suggested Macro Split</h4>
                        <div id="macro-suggestion-content"></div>
                        <button class="btn btn-sm" onclick="applySuggestedMacros()" style="margin-top: 15px; width: 100%;">Apply These Macros</button>
                    </div>

                    <div class="toggle-container">
                        <button class="toggle-btn active" id="percentage-toggle" onclick="toggleMacroType('percentage')">Percentage</button>
                        <button class="toggle-btn" id="grams-toggle" onclick="toggleMacroType('grams')">Grams</button>
                    </div>

                    <div id="percentage-inputs">
                        <div class="input-group">
                            <label>Carbs %</label>
                            <input type="number" id="carbs-percent" value="40">
                        </div>
                        <div class="input-group">
                            <label>Protein %</label>
                            <input type="number" id="protein-percent" value="30">
                        </div>
                        <div class="input-group">
                            <label>Fat %</label>
                            <input type="number" id="fat-percent" value="30">
                        </div>
                    </div>

                    <div id="grams-inputs" style="display: none;">
                        <div class="input-group">
                            <label>Carbs (g)</label>
                            <input type="number" id="carbs-grams" value="250">
                        </div>
                        <div class="input-group">
                            <label>Protein (g)</label>
                            <input type="number" id="protein-grams" value="150">
                        </div>
                        <div class="input-group">
                            <label>Fat (g)</label>
                            <input type="number" id="fat-grams" value="67">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Dietary Preferences</h3>
                    <div class="input-group">
                        <label>Diet Type</label>
                        <input type="text" id="diet-type" placeholder="e.g., Keto, Vegan">
                    </div>
                    <div class="input-group">
                        <label>Allergies</label>
                        <input type="text" id="allergies" placeholder="e.g., Peanuts, Shellfish">
                    </div>
                    <div class="input-group">
                        <label>Foods to Avoid</label>
                        <input type="text" id="dislikes" placeholder="e.g., Seafood, Mushrooms">
                    </div>
                    <div class="input-group">
                        <label>Health Goals</label>
                        <textarea id="health-goals" rows="3" placeholder="e.g., Heart health, Lower cholesterol"></textarea>
                    </div>
                </div>

                <button class="btn" onclick="saveProfile()">Save Profile</button>
            </div>

            <!-- Meal Planner Section -->
            <div id="mealplan" class="section">
                <h2 class="section-title">AI Meal Planner</h2>
                
                <div class="chat-container" id="chat-container">
                    <div class="chat-message assistant">
                        <p><strong>AI:</strong> Hi! Ask me to create meal plans for you. Try: "Create meals for a week" or "Give me 5 dinner ideas"</p>
                    </div>
                </div>

                <div class="chat-input-container">
                    <input type="text" id="chat-input" class="input-group input chat-input" placeholder="Ask for meals..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="btn" onclick="sendMessage()">Generate</button>
                </div>

                <div id="generated-meals-section" style="display: none;">
                    <h3 style="margin-top: 30px; color: #4CAF50;">Generated Meals</h3>
                    <p style="color: #666; margin-bottom: 15px;">Each meal has a suggested day (pre-selected). Change the day if needed, then click "Assign". Or use Quick Assign below!</p>
                    
                    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="quickAssignAll()">‚úì Quick Assign All (Keep Suggested Days)</button>
                        <button class="btn btn-danger" onclick="clearGeneratedMeals()">Clear All</button>
                    </div>
                    
                    <div id="generated-meals-list" class="generated-meals"></div>
                </div>
            </div>

            <!-- Week View Section -->
            <div id="weekview" class="section">
                <h2 class="section-title">Week View</h2>
                <p style="color: #666; margin-bottom: 20px;">Your meal plan for the week. Adjust servings and click meals to mark as eaten.</p>
                
                <div style="margin-bottom: 20px; text-align: center;">
                    <button class="btn btn-secondary" onclick="showSection('mealplan')">+ Add New Meals</button>
                </div>
                
                <div id="week-calendar" class="week-view"></div>
            </div>

            <!-- Food Log Section -->
            <div id="foodlog" class="section">
                <h2 class="section-title">Food Log</h2>
                
                <div class="card">
                    <h3>üîç Search Food Database</h3>
                    <div class="input-group" style="position: relative;">
                        <label>Search for food (powered by USDA FoodData Central)</label>
                        <input type="text" id="food-search" placeholder="Start typing to search... e.g., 'chicken breast'" 
                               oninput="searchFood(this.value)" autocomplete="off">
                        <div id="search-results" class="search-results"></div>
                    </div>
                    
                    <div style="text-align: center; margin: 15px 0; color: #999; font-size: 14px;">
                        <span>OR</span>
                    </div>
                    
                    <div class="input-group">
                        <label>üì∑ Scan Barcode (UPC)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="barcode-input" placeholder="Enter barcode number" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="searchByBarcode()">Scan</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">Enter the barcode number from the product</small>
                    </div>
                </div>

                <div class="card">
                    <h3>Manual Entry</h3>
                    <div class="input-group">
                        <label>Food Name</label>
                        <input type="text" id="food-name" placeholder="e.g., Chicken Breast">
                    </div>
                    <div class="input-group">
                        <label>Calories (per serving)</label>
                        <input type="number" id="food-calories" placeholder="165">
                    </div>
                    <div class="input-group">
                        <label>Carbs (g per serving)</label>
                        <input type="number" id="food-carbs" placeholder="0">
                    </div>
                    <div class="input-group">
                        <label>Protein (g per serving)</label>
                        <input type="number" id="food-protein" placeholder="31">
                    </div>
                    <div class="input-group">
                        <label>Fat (g per serving)</label>
                        <input type="number" id="food-fat" placeholder="3.6">
                    </div>
                    <div class="input-group">
                        <label>Servings</label>
                        <input type="number" id="food-servings" placeholder="1" value="1" step="0.1" min="0.1">
                        <small style="color: #666; display: block; margin-top: 5px;">Enter 0.5 for half serving, 2 for double, etc.</small>
                    </div>
                    <button class="btn" onclick="addFood()">Log Food</button>
                </div>

                <div class="card">
                    <h3>Today's Log</h3>
                    <div id="food-log-list"></div>
                </div>
            </div>

            <!-- Shopping List Section -->
            <div id="shopping" class="section">
                <h2 class="section-title">Shopping List</h2>
                
                <div class="card">
                    <div id="shopping-list-content">
                        <p style="color: #999; text-align: center; padding: 40px;">Generate meals to see your shopping list!</p>
                    </div>
                </div>

                <button class="btn btn-danger" onclick="clearShoppingList()">Clear List</button>
            </div>
        </div>
    </div>

    <!-- Edit Meal Modal -->
    <div id="edit-modal" class="modal" onclick="if(event.target.id==='edit-modal') closeEditModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Meal</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <div>
                <p style="color: #666; margin-bottom: 20px;">Adjust the servings and macros to match what you actually ate:</p>
                
                <div class="input-group">
                    <label>Meal Name</label>
                    <input type="text" id="edit-meal-name" readonly style="background: #f5f5f5;">
                </div>

                <div class="input-group">
                    <label>Servings <span style="color: #999; font-size: 12px;">(0.5 = half, 1 = full, 2 = double)</span></label>
                    <input type="number" id="edit-servings" placeholder="1" value="1" step="0.1" min="0.1" oninput="recalculateFromServings()">
                </div>

                <div class="input-group">
                    <label>Calories (auto-calculated from macros below)</label>
                    <input type="number" id="edit-calories" placeholder="165" readonly style="background: #f5f5f5; font-weight: bold; color: #4CAF50;">
                </div>

                <div class="input-group">
                    <label>Carbs (g) <span style="color: #999; font-size: 12px;">√ó 4 cal/g</span></label>
                    <input type="number" id="edit-carbs" placeholder="0" oninput="recalculateCalories()">
                </div>

                <div class="input-group">
                    <label>Protein (g) <span style="color: #999; font-size: 12px;">√ó 4 cal/g</span></label>
                    <input type="number" id="edit-protein" placeholder="31" oninput="recalculateCalories()">
                </div>

                <div class="input-group">
                    <label>Fat (g) <span style="color: #999; font-size: 12px;">√ó 9 cal/g</span></label>
                    <input type="number" id="edit-fat" placeholder="3.6" oninput="recalculateCalories()">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" onclick="saveEditedMeal()" style="flex: 1;">Save Changes</button>
                    <button class="btn btn-danger" onclick="closeEditModal()" style="flex: 1;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Food Log Modal -->
    <div id="edit-food-modal" class="modal" onclick="if(event.target.id==='edit-food-modal') closeEditFoodModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Food Log Entry</h2>
                <button class="close-btn" onclick="closeEditFoodModal()">&times;</button>
            </div>
            <div>
                <div class="input-group">
                    <label>Food Name</label>
                    <input type="text" id="edit-food-name">
                </div>

                <div class="input-group">
                    <label>Servings <span style="color: #999; font-size: 12px;">(0.5 = half, 1 = full, 2 = double)</span></label>
                    <input type="number" id="edit-food-servings" placeholder="1" value="1" step="0.1" min="0.1" oninput="recalculateFoodFromServings()">
                </div>

                <div class="input-group">
                    <label>Calories per serving</label>
                    <input type="number" id="edit-food-calories-per" placeholder="165" oninput="recalculateFoodTotals()">
                </div>

                <div class="input-group">
                    <label>Carbs (g per serving)</label>
                    <input type="number" id="edit-food-carbs-per" placeholder="0" oninput="recalculateFoodTotals()">
                </div>

                <div class="input-group">
                    <label>Protein (g per serving)</label>
                    <input type="number" id="edit-food-protein-per" placeholder="31" oninput="recalculateFoodTotals()">
                </div>

                <div class="input-group">
                    <label>Fat (g per serving)</label>
                    <input type="number" id="edit-food-fat-per" placeholder="3.6" oninput="recalculateFoodTotals()">
                </div>

                <div style="background: #E8F5E9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #4CAF50; margin-bottom: 10px;">Total (for <span id="food-total-servings">1</span> serving<span id="food-plural">s</span>)</h4>
                    <p id="food-totals" style="color: #333; font-weight: 600;"></p>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" onclick="saveEditedFood()" style="flex: 1;">Save Changes</button>
                    <button class="btn btn-danger" onclick="closeEditFoodModal()" style="flex: 1;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="auth-container" class="auth-container">
        <div class="auth-box">
            <div id="login-form">
                <h2>Welcome Back!</h2>
                <p>Login to sync your data across devices</p>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="login-email" placeholder="your@email.com">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn" onclick="login()" style="width: 100%;">Login</button>
                <div class="auth-toggle">
                    Don't have an account? <a onclick="showSignup()">Sign Up</a>
                </div>
            </div>

            <div id="signup-form" style="display: none;">
                <h2>Create Account</h2>
                <p>Sign up to access your data anywhere</p>
                <div class="input-group">
                    <label>Name</label>
                    <input type="text" id="signup-name" placeholder="Your Name">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="signup-email" placeholder="your@email.com">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="signup-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                    <small style="color: #666; display: block; margin-top: 5px;">Minimum 6 characters</small>
                </div>
                <button class="btn" onclick="signup()" style="width: 100%;">Sign Up</button>
                <div class="auth-toggle">
                    Already have an account? <a onclick="showLogin()">Login</a>
                </div>
            </div>
        </div>
    </div>

    <script>
// Firebase Configuration
// Your Firebase project credentials
const firebaseConfig = {
    apiKey: "AIzaSyCVwscL-mtp9RBY1tUWxZKRCsVzYmcqUOk",
    authDomain: "food-tracker-ca7bf.firebaseapp.com",
    databaseURL: "https://food-tracker-ca7bf-default-rtdb.firebaseio.com",
    projectId: "food-tracker-ca7bf",
    storageBucket: "food-tracker-ca7bf.firebasestorage.app",
    messagingSenderId: "251471207675",
    appId: "1:251471207675:web:3bdde1caaba4deaa40245e",
    measurementId: "G-2Z0ZT9XZJ6"
};

// Initialize Firebase
let firebaseInitialized = false;
let currentUser = null;
let database = null;

try {
    firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    firebaseInitialized = true;
    console.log('Firebase initialized successfully');
} catch (error) {
    console.warn('Firebase not configured. Using local storage only.', error);
    firebaseInitialized = false;
}

// Authentication Functions
function showAuth() {
    document.getElementById('auth-container').classList.add('show');
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('signup-form').style.display = 'none';
}

function hideAuth() {
    document.getElementById('auth-container').classList.remove('show');
}

function showSignup() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('signup-form').style.display = 'block';
}

function showLogin() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('signup-form').style.display = 'none';
}

async function signup() {
    if (!firebaseInitialized) {
        alert('Firebase is not configured. Please add your Firebase credentials to use cloud sync.');
        return;
    }

    const name = document.getElementById('signup-name').value.trim();
    const email = document.getElementById('signup-email').value.trim();
    const password = document.getElementById('signup-password').value;

    if (!name || !email || !password) {
        alert('Please fill in all fields');
        return;
    }

    if (password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
    }

    try {
        setSyncStatus('syncing');
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Save user profile with name
        await database.ref('users/' + user.uid + '/profile').set({
            name: name,
            email: email,
            createdAt: new Date().toISOString()
        });

        alert('Account created successfully!');
        hideAuth();
    } catch (error) {
        console.error('Signup error:', error);
        alert('Error: ' + error.message);
        setSyncStatus('offline');
    }
}

async function login() {
    if (!firebaseInitialized) {
        alert('Firebase is not configured. Please add your Firebase credentials to use cloud sync.');
        return;
    }

    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;

    if (!email || !password) {
        alert('Please fill in all fields');
        return;
    }

    try {
        setSyncStatus('syncing');
        await firebase.auth().signInWithEmailAndPassword(email, password);
        hideAuth();
    } catch (error) {
        console.error('Login error:', error);
        alert('Error: ' + error.message);
        setSyncStatus('offline');
    }
}

async function logout() {
    if (!firebaseInitialized) return;

    if (confirm('Are you sure you want to logout?')) {
        try {
            await firebase.auth().signOut();
            document.getElementById('user-dropdown').classList.remove('show');
            location.reload(); // Refresh page to clear data
        } catch (error) {
            console.error('Logout error:', error);
            alert('Error logging out');
        }
    }
}

function toggleUserMenu() {
    document.getElementById('user-dropdown').classList.toggle('show');
}

// Close user menu when clicking outside
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    if (userMenu && !userMenu.contains(event.target)) {
        document.getElementById('user-dropdown').classList.remove('show');
    }
});

function setSyncStatus(status) {
    const statusEl = document.getElementById('sync-status');
    if (!statusEl) return;
    
    statusEl.className = 'sync-status ' + status;
    
    if (status === 'synced') {
        statusEl.textContent = '‚úì Synced';
    } else if (status === 'syncing') {
        statusEl.textContent = '‚ü≥ Syncing...';
    } else if (status === 'offline') {
        statusEl.textContent = '‚ö† Offline';
    }
}

// Monitor auth state
if (firebaseInitialized) {
    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('user-section').style.display = 'block';
            document.getElementById('login-button').style.display = 'none';
            
            // Get user name from database
            const nameSnapshot = await database.ref('users/' + user.uid + '/profile/name').once('value');
            const userName = nameSnapshot.val() || user.email.split('@')[0];
            
            document.getElementById('user-display-name').textContent = userName;
            document.getElementById('user-email-display').textContent = user.email;
            
            // Load data from cloud
            loadFromCloud();
            setSyncStatus('synced');
        } else {
            currentUser = null;
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('login-button').style.display = 'inline-block';
            setSyncStatus('offline');
            
            // Load from local storage when not logged in
            loadProfile();
            loadFoodLog();
            loadMeals();
            loadShoppingList();
        }
    });
}

// Cloud Storage Functions
async function saveToCloud() {
    if (!firebaseInitialized || !currentUser) {
        // Fallback to localStorage
        saveToLocalStorage();
        return;
    }

    try {
        setSyncStatus('syncing');
        const userId = currentUser.uid;
        
        await database.ref('users/' + userId).update({
            userProfile: userProfile,
            foodLog: foodLog,
            assignedMeals: assignedMeals,
            generatedMeals: generatedMeals,
            shoppingList: shoppingList,
            lastUpdated: new Date().toISOString()
        });
        
        setSyncStatus('synced');
    } catch (error) {
        console.error('Cloud save error:', error);
        setSyncStatus('offline');
        // Fallback to localStorage
        saveToLocalStorage();
    }
}

async function loadFromCloud() {
    if (!firebaseInitialized || !currentUser) {
        return;
    }

    try {
        setSyncStatus('syncing');
        const userId = currentUser.uid;
        const snapshot = await database.ref('users/' + userId).once('value');
        const data = snapshot.val();

        if (data) {
            if (data.userProfile) userProfile = data.userProfile;
            if (data.foodLog) foodLog = data.foodLog;
            if (data.assignedMeals) assignedMeals = data.assignedMeals;
            if (data.generatedMeals) generatedMeals = data.generatedMeals;
            if (data.shoppingList) shoppingList = data.shoppingList;

            // Update UI
            loadProfile();
            updateFoodLogDisplay();
            updateGeneratedMealsDisplay();
            updateDashboard();
            updateWeekView();
            displayShoppingList();
        }
        
        setSyncStatus('synced');
    } catch (error) {
        console.error('Cloud load error:', error);
        setSyncStatus('offline');
    }
}

function saveToLocalStorage() {
    localStorage.setItem('userProfile', JSON.stringify(userProfile));
    localStorage.setItem('foodLog', JSON.stringify(foodLog));
    localStorage.setItem('assignedMeals', JSON.stringify(assignedMeals));
    localStorage.setItem('generatedMeals', JSON.stringify(generatedMeals));
    localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
}

let userProfile = {
    name: '',
    gender: '',
    age: null,
    units: 'imperial',
    weight: { imperial: null, metric: null },
    targetWeight: { imperial: null, metric: null },
    height: { feet: null, inches: null, cm: null },
    activityLevel: 1.55,
    bmr: null,
    tdee: null,
    dailyCalories: 2000,
    macroType: 'percentage',
    macros: { carbs: 250, protein: 150, fat: 67 },
    preferences: { dietType: '', allergies: [], dislikes: [], healthGoals: [] }
};

let foodLog = [];
let generatedMeals = []; // Unassigned meals from AI
let assignedMeals = [];  // Meals assigned to specific dates
let shoppingList = [];
let currentEditingMealId = null;
let currentEditingFoodId = null;
let currentViewDate = new Date().toISOString().split('T')[0]; // Currently viewing date
let searchTimeout = null;

// FoodData Central API Key - Unlimited searches!
const FOOD_API_KEY = 'sTLO6YQSliHVr0a3sh2EkP59cqq4mwfRkthXV60i';

window.onload = function() {
    loadProfile();
    loadFoodLog();
    loadMeals();
    loadShoppingList();
    initializeDatePicker();
    updateDashboard();
    updateWeekView();
};

function initializeDatePicker() {
    const dateInput = document.getElementById('view-date');
    dateInput.value = currentViewDate;
    updateDateLabel();
}

function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    
    // Find and activate the corresponding nav button
    const navButtons = document.querySelectorAll('.nav-btn');
    navButtons.forEach(btn => {
        if (btn.textContent.toLowerCase().includes(sectionId.replace('mealplan', 'ai meal planner').replace('weekview', 'week view').replace('foodlog', 'food log').replace('shopping', 'shopping list'))) {
            btn.classList.add('active');
        }
    });
    
    // Handle onclick from event if available
    if (typeof event !== 'undefined' && event && event.target && event.target.classList.contains('nav-btn')) {
        navButtons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }
    
    if (sectionId === 'dashboard') updateDashboard();
    if (sectionId === 'weekview') updateWeekView();
    if (sectionId === 'shopping') displayShoppingList();
}

function changeViewDate(days) {
    const date = new Date(currentViewDate);
    date.setDate(date.getDate() + days);
    currentViewDate = date.toISOString().split('T')[0];
    document.getElementById('view-date').value = currentViewDate;
    updateDateLabel();
    updateDashboard();
}

function onDateChange() {
    currentViewDate = document.getElementById('view-date').value;
    updateDateLabel();
    updateDashboard();
}

function goToToday() {
    currentViewDate = new Date().toISOString().split('T')[0];
    document.getElementById('view-date').value = currentViewDate;
    updateDateLabel();
    updateDashboard();
}

function updateDateLabel() {
    const dateObj = new Date(currentViewDate + 'T12:00:00'); // Noon to avoid timezone issues
    const today = new Date().toISOString().split('T')[0];
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    let label = '';
    if (currentViewDate === today) {
        label = 'Today';
    } else if (currentViewDate === yesterdayStr) {
        label = 'Yesterday';
    } else if (currentViewDate === tomorrowStr) {
        label = 'Tomorrow';
    } else {
        label = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    
    document.getElementById('date-label').textContent = label;
}

function toggleMacroType(type) {
    const percentageInputs = document.getElementById('percentage-inputs');
    const gramsInputs = document.getElementById('grams-inputs');
    const percentageToggle = document.getElementById('percentage-toggle');
    const gramsToggle = document.getElementById('grams-toggle');
    
    if (type === 'percentage') {
        percentageInputs.style.display = 'block';
        gramsInputs.style.display = 'none';
        percentageToggle.classList.add('active');
        gramsToggle.classList.remove('active');
    } else {
        percentageInputs.style.display = 'none';
        gramsInputs.style.display = 'block';
        percentageToggle.classList.remove('active');
        gramsToggle.classList.add('active');
    }
    userProfile.macroType = type;
}

function toggleUnits(units) {
    const imperialInputs = document.getElementById('imperial-inputs');
    const metricInputs = document.getElementById('metric-inputs');
    const imperialToggle = document.getElementById('imperial-toggle');
    const metricToggle = document.getElementById('metric-toggle');
    
    if (units === 'imperial') {
        imperialInputs.style.display = 'block';
        metricInputs.style.display = 'none';
        imperialToggle.classList.add('active');
        metricToggle.classList.remove('active');
        
        // Convert metric to imperial if metric values exist
        const kgWeight = parseFloat(document.getElementById('weight-kg').value);
        const kgTarget = parseFloat(document.getElementById('target-weight-kg').value);
        const cmHeight = parseFloat(document.getElementById('height-cm').value);
        
        if (!isNaN(kgWeight)) {
            document.getElementById('weight-lbs').value = (kgWeight * 2.20462).toFixed(1);
        }
        if (!isNaN(kgTarget)) {
            document.getElementById('target-weight-lbs').value = (kgTarget * 2.20462).toFixed(1);
        }
        if (!isNaN(cmHeight)) {
            const totalInches = cmHeight / 2.54;
            const feet = Math.floor(totalInches / 12);
            const inches = (totalInches % 12).toFixed(1);
            document.getElementById('height-feet').value = feet;
            document.getElementById('height-inches').value = inches;
        }
    } else {
        imperialInputs.style.display = 'none';
        metricInputs.style.display = 'block';
        imperialToggle.classList.remove('active');
        metricToggle.classList.add('active');
        
        // Convert imperial to metric if imperial values exist
        const lbsWeight = parseFloat(document.getElementById('weight-lbs').value);
        const lbsTarget = parseFloat(document.getElementById('target-weight-lbs').value);
        const feet = parseFloat(document.getElementById('height-feet').value);
        const inches = parseFloat(document.getElementById('height-inches').value);
        
        if (!isNaN(lbsWeight)) {
            document.getElementById('weight-kg').value = (lbsWeight / 2.20462).toFixed(1);
        }
        if (!isNaN(lbsTarget)) {
            document.getElementById('target-weight-kg').value = (lbsTarget / 2.20462).toFixed(1);
        }
        if (!isNaN(feet) && !isNaN(inches)) {
            const totalInches = (feet * 12) + inches;
            document.getElementById('height-cm').value = (totalInches * 2.54).toFixed(1);
        }
    }
    userProfile.units = units;
}

function calculateCalories() {
    const gender = document.getElementById('user-gender').value;
    const age = parseFloat(document.getElementById('user-age').value);
    const activityLevel = parseFloat(document.getElementById('activity-level').value);
    
    if (!gender || !age) {
        alert('Please enter your gender and age first!');
        return;
    }
    
    let weightKg, heightCm;
    
    // Get weight and height in metric (convert if needed)
    if (userProfile.units === 'imperial') {
        const lbs = parseFloat(document.getElementById('weight-lbs').value);
        const feet = parseFloat(document.getElementById('height-feet').value);
        const inches = parseFloat(document.getElementById('height-inches').value);
        
        if (isNaN(lbs) || isNaN(feet) || isNaN(inches)) {
            alert('Please fill in your weight and height!');
            return;
        }
        
        weightKg = lbs / 2.20462;
        heightCm = ((feet * 12) + inches) * 2.54;
    } else {
        weightKg = parseFloat(document.getElementById('weight-kg').value);
        heightCm = parseFloat(document.getElementById('height-cm').value);
        
        if (isNaN(weightKg) || isNaN(heightCm)) {
            alert('Please fill in your weight and height!');
            return;
        }
    }
    
    // Mifflin-St Jeor Formula
    // Men: BMR = (10 √ó weight in kg) + (6.25 √ó height in cm) - (5 √ó age in years) + 5
    // Women: BMR = (10 √ó weight in kg) + (6.25 √ó height in cm) - (5 √ó age in years) - 161
    
    let bmr;
    if (gender === 'male') {
        bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
    } else {
        bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
    }
    
    // TDEE = BMR √ó Activity Level
    const tdee = bmr * activityLevel;
    
    // Store results
    userProfile.bmr = Math.round(bmr);
    userProfile.tdee = Math.round(tdee);
    
    // Display results
    document.getElementById('bmr-result').textContent = Math.round(bmr) + ' calories/day';
    document.getElementById('tdee-result').textContent = Math.round(tdee) + ' calories/day';
    document.getElementById('calorie-results').style.display = 'block';
    
    // Scroll to results
    document.getElementById('calorie-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

let suggestedMacros = null; // Store suggested macros for applying later
let suggestedCalories = null; // Store suggested calories for applying later

function calculateSuggestedCalories() {
    const goalType = document.getElementById('goal-type').value;
    
    // Check if TDEE has been calculated
    if (!userProfile.tdee) {
        alert('Please calculate your TDEE first in the "Personal Information" section above!');
        document.getElementById('user-name').scrollIntoView({ behavior: 'smooth', block: 'start' });
        return;
    }
    
    const tdee = userProfile.tdee;
    let suggestedCals, deficit, surplus, rationale, weeklyChange, timeEstimate;
    
    // Get current and target weight for time estimation
    let currentWeight, targetWeight;
    if (userProfile.units === 'imperial') {
        currentWeight = parseFloat(document.getElementById('weight-lbs').value);
        targetWeight = parseFloat(document.getElementById('target-weight-lbs').value);
    } else {
        currentWeight = parseFloat(document.getElementById('weight-kg').value);
        targetWeight = parseFloat(document.getElementById('target-weight-kg').value);
        // Convert to lbs for calculation
        if (!isNaN(currentWeight)) currentWeight *= 2.20462;
        if (!isNaN(targetWeight)) targetWeight *= 2.20462;
    }
    
    if (goalType === 'cut') {
        // Weight Loss: 300-500 calorie deficit
        // Start with 400 cal deficit (moderate)
        deficit = 400;
        suggestedCals = tdee - deficit;
        
        // Don't go below 1200 for women or 1500 for men (minimum safe levels)
        const minCals = userProfile.gender === 'female' ? 1200 : 1500;
        if (suggestedCals < minCals) {
            suggestedCals = minCals;
            deficit = tdee - minCals;
        }
        
        // 3500 calories = 1 lb fat
        weeklyChange = (deficit * 7) / 3500;
        
        rationale = `<strong>Weight Loss Strategy</strong><br>
                    ‚Ä¢ Your TDEE: ${tdee} calories/day<br>
                    ‚Ä¢ Recommended deficit: ${deficit} calories/day<br>
                    ‚Ä¢ This creates a ${Math.round(deficit * 7)} calorie weekly deficit<br><br>
                    <strong style="color: #4CAF50;">Expected Results:</strong><br>
                    ‚Ä¢ Weight loss: ~${weeklyChange.toFixed(1)} lbs per week<br>
                    ‚Ä¢ Safe, sustainable pace (0.5-2 lbs/week is healthy)`;
        
        // Calculate time to goal if both weights are provided
        if (!isNaN(currentWeight) && !isNaN(targetWeight) && currentWeight > targetWeight) {
            const totalLossNeeded = currentWeight - targetWeight;
            const weeksNeeded = Math.ceil(totalLossNeeded / weeklyChange);
            const monthsNeeded = (weeksNeeded / 4.33).toFixed(1);
            timeEstimate = `<br>‚Ä¢ Time to reach ${Math.round(targetWeight)} ${userProfile.units === 'imperial' ? 'lbs' : 'kg'}: ~${weeksNeeded} weeks (${monthsNeeded} months)`;
            rationale += timeEstimate;
        }
        
        rationale += `<br><br>üí° <em>Adjust every 2-4 weeks as you lose weight</em>`;
        
    } else if (goalType === 'bulk') {
        // Weight Gain: 300-500 calorie surplus
        surplus = 400;
        suggestedCals = tdee + surplus;
        
        weeklyChange = (surplus * 7) / 3500;
        
        rationale = `<strong>Weight Gain Strategy</strong><br>
                    ‚Ä¢ Your TDEE: ${tdee} calories/day<br>
                    ‚Ä¢ Recommended surplus: ${surplus} calories/day<br>
                    ‚Ä¢ This creates a ${Math.round(surplus * 7)} calorie weekly surplus<br><br>
                    <strong style="color: #4CAF50;">Expected Results:</strong><br>
                    ‚Ä¢ Weight gain: ~${weeklyChange.toFixed(1)} lbs per week<br>
                    ‚Ä¢ Lean muscle focus (0.5-1 lb/week is ideal)`;
        
        // Calculate time to goal if both weights are provided
        if (!isNaN(currentWeight) && !isNaN(targetWeight) && targetWeight > currentWeight) {
            const totalGainNeeded = targetWeight - currentWeight;
            const weeksNeeded = Math.ceil(totalGainNeeded / weeklyChange);
            const monthsNeeded = (weeksNeeded / 4.33).toFixed(1);
            timeEstimate = `<br>‚Ä¢ Time to reach ${Math.round(targetWeight)} ${userProfile.units === 'imperial' ? 'lbs' : 'kg'}: ~${weeksNeeded} weeks (${monthsNeeded} months)`;
            rationale += timeEstimate;
        }
        
        rationale += `<br><br>üí° <em>Combine with strength training for best results</em>`;
        
    } else {
        // Maintenance: Match TDEE
        suggestedCals = tdee;
        
        rationale = `<strong>Weight Maintenance Strategy</strong><br>
                    ‚Ä¢ Your TDEE: ${tdee} calories/day<br>
                    ‚Ä¢ Recommended intake: Match your TDEE<br><br>
                    <strong style="color: #4CAF50;">Expected Results:</strong><br>
                    ‚Ä¢ Stable weight maintenance<br>
                    ‚Ä¢ Energy balance for current activity level<br><br>
                    üí° <em>Monitor weekly and adjust ¬±100-200 cals as needed</em>`;
    }
    
    // Store suggestion
    suggestedCalories = Math.round(suggestedCals);
    
    // Create visual display
    const content = `
        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-size: 13px; color: #666; margin-bottom: 15px; line-height: 1.8;">${rationale}</div>
            
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50, #8BC34A); border-radius: 10px; color: white; margin-top: 15px;">
                <div style="font-size: 14px; font-weight: 600; opacity: 0.9; margin-bottom: 8px;">RECOMMENDED DAILY CALORIES</div>
                <div style="font-size: 42px; font-weight: bold; margin: 10px 0;">${suggestedCalories}</div>
                <div style="font-size: 14px; opacity: 0.9;">calories per day</div>
            </div>
            
            ${goalType === 'cut' ? `
                <div style="margin-top: 15px; padding: 12px; background: #FFF3E0; border-left: 4px solid #FF9800; border-radius: 4px;">
                    <strong style="color: #F57C00;">Pro Tips for Cutting:</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #666; line-height: 1.6;">
                        <li>Prioritize protein to preserve muscle</li>
                        <li>Track weight weekly, not daily</li>
                        <li>If losing >2 lbs/week, increase calories</li>
                        <li>If not losing after 2 weeks, reduce by 100-200 cal</li>
                    </ul>
                </div>
            ` : ''}
            
            ${goalType === 'bulk' ? `
                <div style="margin-top: 15px; padding: 12px; background: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 4px;">
                    <strong style="color: #1976D2;">Pro Tips for Bulking:</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #666; line-height: 1.6;">
                        <li>Gain slowly to minimize fat gain</li>
                        <li>If gaining >1.5 lbs/week, reduce calories</li>
                        <li>Focus on progressive overload in training</li>
                        <li>Get 7-9 hours of sleep for recovery</li>
                    </ul>
                </div>
            ` : ''}
            
            ${goalType === 'maintain' ? `
                <div style="margin-top: 15px; padding: 12px; background: #F3E5F5; border-left: 4px solid #9C27B0; border-radius: 4px;">
                    <strong style="color: #7B1FA2;">Pro Tips for Maintenance:</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #666; line-height: 1.6;">
                        <li>Weigh weekly to catch drift early</li>
                        <li>Adjust calories if weight changes >2-3 lbs</li>
                        <li>Increase protein on training days if desired</li>
                        <li>This is great for recomposition!</li>
                    </ul>
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('calorie-suggestion-content').innerHTML = content;
    document.getElementById('calorie-suggestions').style.display = 'block';
    document.getElementById('calorie-suggestions').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function applySuggestedCalories() {
    if (!suggestedCalories) return;
    
    document.getElementById('daily-calories').value = suggestedCalories;
    
    // Highlight the input briefly
    const input = document.getElementById('daily-calories');
    input.style.background = '#C8E6C9';
    setTimeout(() => {
        input.style.background = '';
    }, 1000);
    
    alert(`Calorie goal set to ${suggestedCalories}! Now click "Calculate Suggested Macros" below, then "Save Profile" at the bottom.`);
}

function calculateSuggestedMacros() {
    const calories = parseInt(document.getElementById('daily-calories').value);
    const goalType = document.getElementById('goal-type').value;
    const activityLevel = parseFloat(document.getElementById('activity-level').value);
    
    if (!calories || calories <= 0) {
        alert('Please enter a valid daily calorie goal first!');
        return;
    }
    
    // Get current weight for protein calculation
    let weightKg;
    if (userProfile.units === 'imperial') {
        const lbs = parseFloat(document.getElementById('weight-lbs').value);
        if (!isNaN(lbs)) {
            weightKg = lbs / 2.20462;
        }
    } else {
        weightKg = parseFloat(document.getElementById('weight-kg').value);
    }
    
    let proteinPercent, carbsPercent, fatPercent;
    let proteinGrams, carbsGrams, fatGrams;
    let rationale;
    
    // Calculate based on goal type
    if (goalType === 'cut') {
        // Weight Loss: Higher protein to preserve muscle, moderate fat, lower carbs
        // Protein: 30-40%, Fat: 25-30%, Carbs: 30-45%
        proteinPercent = 35;
        fatPercent = 25;
        carbsPercent = 40;
        
        // If we have weight, aim for 1.0-1.2g protein per lb (2.2-2.6g per kg)
        if (weightKg) {
            proteinGrams = Math.round(weightKg * 2.4); // 2.4g per kg = ~1.1g per lb
            const proteinCals = proteinGrams * 4;
            
            // Adjust if protein calories would be too high
            if (proteinCals > calories * 0.4) {
                proteinGrams = Math.round((calories * 0.35) / 4);
            }
        } else {
            proteinGrams = Math.round((calories * proteinPercent / 100) / 4);
        }
        
        fatGrams = Math.round((calories * fatPercent / 100) / 9);
        
        // Remaining calories go to carbs
        const remainingCals = calories - (proteinGrams * 4) - (fatGrams * 9);
        carbsGrams = Math.round(remainingCals / 4);
        
        rationale = `<strong>Weight Loss (Cut)</strong><br>
                    ‚Ä¢ Higher protein (${proteinPercent}%) to preserve muscle mass<br>
                    ‚Ä¢ Moderate fat (${fatPercent}%) for hormone health<br>
                    ‚Ä¢ Lower carbs (${carbsPercent}%) to create deficit<br>
                    üí° Aim for 0.5-1 lb loss per week`;
        
    } else if (goalType === 'bulk') {
        // Weight Gain: Moderate-high protein, higher carbs for energy, moderate fat
        // Protein: 25-30%, Fat: 25-30%, Carbs: 40-50%
        proteinPercent = 25;
        fatPercent = 25;
        carbsPercent = 50;
        
        // If we have weight, aim for 0.8-1.0g protein per lb (1.8-2.2g per kg)
        if (weightKg) {
            proteinGrams = Math.round(weightKg * 2.0); // 2.0g per kg = ~0.9g per lb
            const proteinCals = proteinGrams * 4;
            
            if (proteinCals > calories * 0.3) {
                proteinGrams = Math.round((calories * 0.25) / 4);
            }
        } else {
            proteinGrams = Math.round((calories * proteinPercent / 100) / 4);
        }
        
        fatGrams = Math.round((calories * fatPercent / 100) / 9);
        
        // Remaining calories go to carbs (more for muscle building)
        const remainingCals = calories - (proteinGrams * 4) - (fatGrams * 9);
        carbsGrams = Math.round(remainingCals / 4);
        
        rationale = `<strong>Weight Gain (Bulk)</strong><br>
                    ‚Ä¢ Moderate protein (${proteinPercent}%) for muscle growth<br>
                    ‚Ä¢ Higher carbs (${carbsPercent}%) for energy and recovery<br>
                    ‚Ä¢ Moderate fat (${fatPercent}%) for hormone production<br>
                    üí° Aim for 0.5-1 lb gain per week`;
        
    } else {
        // Maintenance: Balanced macros
        // Protein: 25-30%, Fat: 25-30%, Carbs: 40-50%
        
        if (activityLevel >= 1.725) {
            // Very/extremely active: higher carbs
            proteinPercent = 25;
            fatPercent = 25;
            carbsPercent = 50;
        } else if (activityLevel >= 1.55) {
            // Moderately active: balanced
            proteinPercent = 30;
            fatPercent = 25;
            carbsPercent = 45;
        } else {
            // Sedentary/lightly active: slightly lower carbs
            proteinPercent = 30;
            fatPercent = 30;
            carbsPercent = 40;
        }
        
        // If we have weight, aim for 0.7-0.9g protein per lb (1.5-2.0g per kg)
        if (weightKg) {
            proteinGrams = Math.round(weightKg * 1.8); // 1.8g per kg = ~0.8g per lb
            const proteinCals = proteinGrams * 4;
            
            if (proteinCals > calories * 0.35) {
                proteinGrams = Math.round((calories * 0.3) / 4);
            }
        } else {
            proteinGrams = Math.round((calories * proteinPercent / 100) / 4);
        }
        
        fatGrams = Math.round((calories * fatPercent / 100) / 9);
        
        // Remaining calories go to carbs
        const remainingCals = calories - (proteinGrams * 4) - (fatGrams * 9);
        carbsGrams = Math.round(remainingCals / 4);
        
        rationale = `<strong>Maintain Weight</strong><br>
                    ‚Ä¢ Balanced protein (${proteinPercent}%) for maintenance<br>
                    ‚Ä¢ Moderate fat (${fatPercent}%) for health<br>
                    ‚Ä¢ ${carbsPercent}% carbs based on your activity level<br>
                    üí° Adjust based on energy levels`;
    }
    
    // Recalculate percentages based on actual grams
    const totalCals = (proteinGrams * 4) + (carbsGrams * 4) + (fatGrams * 9);
    const actualProteinPercent = Math.round((proteinGrams * 4 / totalCals) * 100);
    const actualCarbsPercent = Math.round((carbsGrams * 4 / totalCals) * 100);
    const actualFatPercent = Math.round((fatGrams * 9 / totalCals) * 100);
    
    // Store suggestions
    suggestedMacros = {
        proteinGrams,
        carbsGrams,
        fatGrams,
        proteinPercent: actualProteinPercent,
        carbsPercent: actualCarbsPercent,
        fatPercent: actualFatPercent
    };
    
    // Display suggestions
    const content = `
        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
            <div style="font-size: 13px; color: #666; margin-bottom: 12px; line-height: 1.6;">${rationale}</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                <div style="padding: 12px; background: #FFF3E0; border-radius: 8px;">
                    <div style="color: #FF9800; font-weight: 600; font-size: 12px;">Carbs</div>
                    <div style="font-size: 20px; font-weight: bold; color: #333; margin: 6px 0;">${carbsGrams}g</div>
                    <div style="font-size: 12px; color: #999;">${actualCarbsPercent}%</div>
                </div>
                <div style="padding: 12px; background: #E3F2FD; border-radius: 8px;">
                    <div style="color: #2196F3; font-weight: 600; font-size: 12px;">Protein</div>
                    <div style="font-size: 20px; font-weight: bold; color: #333; margin: 6px 0;">${proteinGrams}g</div>
                    <div style="font-size: 12px; color: #999;">${actualProteinPercent}%</div>
                </div>
                <div style="padding: 12px; background: #FFEBEE; border-radius: 8px;">
                    <div style="color: #F44336; font-weight: 600; font-size: 12px;">Fat</div>
                    <div style="font-size: 20px; font-weight: bold; color: #333; margin: 6px 0;">${fatGrams}g</div>
                    <div style="font-size: 12px; color: #999;">${actualFatPercent}%</div>
                </div>
            </div>
            <div style="margin-top: 12px; padding: 10px; background: #f5f5f5; border-radius: 6px; font-size: 12px; color: #666;">
                Total: ${totalCals} calories from macros
            </div>
        </div>
    `;
    
    document.getElementById('macro-suggestion-content').innerHTML = content;
    document.getElementById('macro-suggestions').style.display = 'block';
    document.getElementById('macro-suggestions').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function applySuggestedMacros() {
    if (!suggestedMacros) return;
    
    // Switch to grams mode
    toggleMacroType('grams');
    
    // Apply the suggested values
    document.getElementById('carbs-grams').value = suggestedMacros.carbsGrams;
    document.getElementById('protein-grams').value = suggestedMacros.proteinGrams;
    document.getElementById('fat-grams').value = suggestedMacros.fatGrams;
    
    // Also update percentage values in case user switches back
    document.getElementById('carbs-percent').value = suggestedMacros.carbsPercent;
    document.getElementById('protein-percent').value = suggestedMacros.proteinPercent;
    document.getElementById('fat-percent').value = suggestedMacros.fatPercent;
    
    alert('Suggested macros applied! Remember to click "Save Profile" below to save your settings.');
}

function saveProfile() {
    // Personal info
    userProfile.name = document.getElementById('user-name').value;
    userProfile.gender = document.getElementById('user-gender').value;
    userProfile.age = parseInt(document.getElementById('user-age').value) || null;
    userProfile.activityLevel = parseFloat(document.getElementById('activity-level').value);
    
    // Weight and height based on current unit system
    if (userProfile.units === 'imperial') {
        userProfile.weight.imperial = parseFloat(document.getElementById('weight-lbs').value) || null;
        userProfile.targetWeight.imperial = parseFloat(document.getElementById('target-weight-lbs').value) || null;
        userProfile.height.feet = parseFloat(document.getElementById('height-feet').value) || null;
        userProfile.height.inches = parseFloat(document.getElementById('height-inches').value) || null;
        
        // Convert to metric for storage
        if (userProfile.weight.imperial) {
            userProfile.weight.metric = userProfile.weight.imperial / 2.20462;
        }
        if (userProfile.targetWeight.imperial) {
            userProfile.targetWeight.metric = userProfile.targetWeight.imperial / 2.20462;
        }
        if (userProfile.height.feet && userProfile.height.inches !== null) {
            userProfile.height.cm = ((userProfile.height.feet * 12) + userProfile.height.inches) * 2.54;
        }
    } else {
        userProfile.weight.metric = parseFloat(document.getElementById('weight-kg').value) || null;
        userProfile.targetWeight.metric = parseFloat(document.getElementById('target-weight-kg').value) || null;
        userProfile.height.cm = parseFloat(document.getElementById('height-cm').value) || null;
        
        // Convert to imperial for storage
        if (userProfile.weight.metric) {
            userProfile.weight.imperial = userProfile.weight.metric * 2.20462;
        }
        if (userProfile.targetWeight.metric) {
            userProfile.targetWeight.imperial = userProfile.targetWeight.metric * 2.20462;
        }
        if (userProfile.height.cm) {
            const totalInches = userProfile.height.cm / 2.54;
            userProfile.height.feet = Math.floor(totalInches / 12);
            userProfile.height.inches = totalInches % 12;
        }
    }
    
    // Daily calories and macros
    userProfile.dailyCalories = parseInt(document.getElementById('daily-calories').value);
    
    if (userProfile.macroType === 'percentage') {
        const calories = userProfile.dailyCalories;
        const carbsPercent = parseInt(document.getElementById('carbs-percent').value);
        const proteinPercent = parseInt(document.getElementById('protein-percent').value);
        const fatPercent = parseInt(document.getElementById('fat-percent').value);
        
        if (carbsPercent + proteinPercent + fatPercent !== 100) {
            alert('Macro percentages must add up to 100%');
            return;
        }
        
        userProfile.macros.carbs = Math.round((calories * carbsPercent / 100) / 4);
        userProfile.macros.protein = Math.round((calories * proteinPercent / 100) / 4);
        userProfile.macros.fat = Math.round((calories * fatPercent / 100) / 9);
    } else {
        userProfile.macros.carbs = parseInt(document.getElementById('carbs-grams').value);
        userProfile.macros.protein = parseInt(document.getElementById('protein-grams').value);
        userProfile.macros.fat = parseInt(document.getElementById('fat-grams').value);
    }
    
    userProfile.preferences = {
        dietType: document.getElementById('diet-type').value,
        allergies: document.getElementById('allergies').value.split(',').map(s => s.trim()).filter(s => s),
        dislikes: document.getElementById('dislikes').value.split(',').map(s => s.trim()).filter(s => s),
        healthGoals: document.getElementById('health-goals').value.split(',').map(s => s.trim()).filter(s => s)
    };
    
    if (currentUser && firebaseInitialized) {
        saveToCloud();
    } else {
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
    }
    
    alert('Profile saved!');
    updateDashboard();
}

function loadProfile() {
    const saved = localStorage.getItem('userProfile');
    if (saved) {
        userProfile = JSON.parse(saved);
        
        // Load personal info
        document.getElementById('user-name').value = userProfile.name || '';
        document.getElementById('user-gender').value = userProfile.gender || '';
        document.getElementById('user-age').value = userProfile.age || '';
        document.getElementById('activity-level').value = userProfile.activityLevel || 1.55;
        
        // Load units preference and toggle
        if (userProfile.units === 'metric') {
            toggleUnits('metric');
        }
        
        // Load weight and height
        if (userProfile.units === 'imperial') {
            document.getElementById('weight-lbs').value = userProfile.weight.imperial || '';
            document.getElementById('target-weight-lbs').value = userProfile.targetWeight.imperial || '';
            document.getElementById('height-feet').value = userProfile.height.feet || '';
            document.getElementById('height-inches').value = userProfile.height.inches || '';
        } else {
            document.getElementById('weight-kg').value = userProfile.weight.metric || '';
            document.getElementById('target-weight-kg').value = userProfile.targetWeight.metric || '';
            document.getElementById('height-cm').value = userProfile.height.cm || '';
        }
        
        // Load BMR/TDEE if calculated
        if (userProfile.bmr && userProfile.tdee) {
            document.getElementById('bmr-result').textContent = userProfile.bmr + ' calories/day';
            document.getElementById('tdee-result').textContent = userProfile.tdee + ' calories/day';
            document.getElementById('calorie-results').style.display = 'block';
        }
        
        // Load daily calories and macros
        document.getElementById('daily-calories').value = userProfile.dailyCalories;
        if (userProfile.macroType === 'grams') {
            toggleMacroType('grams');
            document.getElementById('carbs-grams').value = userProfile.macros.carbs;
            document.getElementById('protein-grams').value = userProfile.macros.protein;
            document.getElementById('fat-grams').value = userProfile.macros.fat;
        }
        if (userProfile.preferences) {
            document.getElementById('diet-type').value = userProfile.preferences.dietType || '';
            document.getElementById('allergies').value = userProfile.preferences.allergies?.join(', ') || '';
            document.getElementById('dislikes').value = userProfile.preferences.dislikes?.join(', ') || '';
            document.getElementById('health-goals').value = userProfile.preferences.healthGoals?.join(', ') || '';
        }
    }
}

// Food Search Functions
function searchFood(query) {
    clearTimeout(searchTimeout);
    const resultsDiv = document.getElementById('search-results');
    
    if (!query || query.length < 2) {
        resultsDiv.classList.remove('show');
        return;
    }
    
    resultsDiv.innerHTML = '<div class="search-loading">Searching...</div>';
    resultsDiv.classList.add('show');
    
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(
                `https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${FOOD_API_KEY}&query=${encodeURIComponent(query)}&pageSize=10`
            );
            
            if (!response.ok) {
                if (response.status === 403 || response.status === 429) {
                    throw new Error('API_LIMIT');
                }
                throw new Error('API request failed');
            }
            
            const data = await response.json();
            displaySearchResults(data.foods || []);
        } catch (error) {
            console.error('Search error:', error);
            if (error.message === 'API_LIMIT') {
                resultsDiv.innerHTML = '<div class="search-loading" style="color: #FF9800;">‚ö†Ô∏è DEMO_KEY rate limit reached. <a href="https://fdc.nal.usda.gov/api-key-signup.html" target="_blank" style="color: #4CAF50; font-weight: 600;">Get your FREE API key here</a> for unlimited searches, or use manual entry below.</div>';
            } else {
                resultsDiv.innerHTML = '<div class="search-loading" style="color: #f44336;">Error searching. Try again or use manual entry.</div>';
            }
        }
    }, 500);
}

function displaySearchResults(foods) {
    const resultsDiv = document.getElementById('search-results');
    
    if (foods.length === 0) {
        resultsDiv.innerHTML = '<div class="search-loading">No results found. Try different keywords or use manual entry.</div>';
        return;
    }
    
    resultsDiv.innerHTML = foods.map(food => {
        const nutrients = food.foodNutrients || [];
        const calories = nutrients.find(n => n.nutrientName === 'Energy')?.value || 0;
        const protein = nutrients.find(n => n.nutrientName === 'Protein')?.value || 0;
        const carbs = nutrients.find(n => n.nutrientName === 'Carbohydrate, by difference')?.value || 0;
        const fat = nutrients.find(n => n.nutrientName === 'Total lipid (fat)')?.value || 0;
        
        return `
            <div class="search-result-item" onclick="selectFood(${food.fdcId}, '${escapeHtml(food.description)}', ${calories}, ${carbs}, ${protein}, ${fat}, '${escapeHtml(food.brandOwner || '')}')">
                <div class="search-result-name">${food.description}</div>
                ${food.brandOwner ? `<div class="search-result-brand">${food.brandOwner}</div>` : ''}
                <div class="search-result-macros">
                    ${Math.round(calories)} cal | C: ${Math.round(carbs)}g | P: ${Math.round(protein)}g | F: ${Math.round(fat)}g
                    ${food.servingSize ? ` | Serving: ${food.servingSize}${food.servingSizeUnit || 'g'}` : ''}
                </div>
            </div>
        `;
    }).join('');
}

async function searchByBarcode() {
    const barcode = document.getElementById('barcode-input').value.trim();
    const resultsDiv = document.getElementById('search-results');
    
    if (!barcode) {
        alert('Please enter a barcode number');
        return;
    }
    
    resultsDiv.innerHTML = '<div class="search-loading">Scanning barcode...</div>';
    resultsDiv.classList.add('show');
    
    try {
        const response = await fetch(
            `https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${FOOD_API_KEY}&query=${barcode}&dataType=Branded`
        );
        
        if (!response.ok) throw new Error('API request failed');
        
        const data = await response.json();
        
        if (data.foods && data.foods.length > 0) {
            displaySearchResults(data.foods);
        } else {
            resultsDiv.innerHTML = '<div class="search-loading" style="color: #FF9800;">Barcode not found in database. Try manual entry.</div>';
        }
    } catch (error) {
        console.error('Barcode search error:', error);
        resultsDiv.innerHTML = '<div class="search-loading" style="color: #f44336;">Error scanning barcode. Try manual entry.</div>';
    }
}

function selectFood(fdcId, name, calories, carbs, protein, fat, brand) {
    // Populate the manual entry form
    document.getElementById('food-name').value = name + (brand ? ` (${brand})` : '');
    document.getElementById('food-calories').value = Math.round(calories);
    document.getElementById('food-carbs').value = Math.round(carbs * 10) / 10;
    document.getElementById('food-protein').value = Math.round(protein * 10) / 10;
    document.getElementById('food-fat').value = Math.round(fat * 10) / 10;
    document.getElementById('food-servings').value = 1;
    
    // Hide search results
    document.getElementById('search-results').classList.remove('show');
    document.getElementById('food-search').value = '';
    
    // Scroll to manual entry form
    document.getElementById('food-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Optional: Auto-log or let user review first
    // addFood(); // Uncomment to auto-log
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close search results when clicking outside
document.addEventListener('click', function(event) {
    const searchInput = document.getElementById('food-search');
    const resultsDiv = document.getElementById('search-results');
    
    if (searchInput && resultsDiv && 
        !searchInput.contains(event.target) && 
        !resultsDiv.contains(event.target)) {
        resultsDiv.classList.remove('show');
    }
});

function addFood() {
    const name = document.getElementById('food-name').value;
    const caloriesPerServing = parseFloat(document.getElementById('food-calories').value);
    const carbsPerServing = parseFloat(document.getElementById('food-carbs').value);
    const proteinPerServing = parseFloat(document.getElementById('food-protein').value);
    const fatPerServing = parseFloat(document.getElementById('food-fat').value);
    const servings = parseFloat(document.getElementById('food-servings').value) || 1;
    
    if (!name || isNaN(caloriesPerServing) || isNaN(carbsPerServing) || isNaN(proteinPerServing) || isNaN(fatPerServing)) {
        alert('Please fill in all fields');
        return;
    }
    
    foodLog.push({
        id: Date.now(),
        date: new Date().toISOString().split('T')[0],
        name,
        caloriesPerServing,
        carbsPerServing,
        proteinPerServing,
        fatPerServing,
        servings,
        calories: caloriesPerServing * servings,
        carbs: carbsPerServing * servings,
        protein: proteinPerServing * servings,
        fat: fatPerServing * servings,
        timestamp: new Date().toLocaleTimeString()
    });
    
    saveFoodLog();
    document.getElementById('food-name').value = '';
    document.getElementById('food-calories').value = '';
    document.getElementById('food-carbs').value = '';
    document.getElementById('food-protein').value = '';
    document.getElementById('food-fat').value = '';
    document.getElementById('food-servings').value = '1';
    
    updateFoodLogDisplay();
    updateDashboard();
    alert('Food logged!');
}

function deleteFood(id) {
    if (confirm('Delete this food?')) {
        foodLog = foodLog.filter(food => food.id !== id);
        saveFoodLog();
        updateFoodLogDisplay();
        updateDashboard();
    }
}

function editFood(id) {
    const food = foodLog.find(f => f.id === id);
    if (!food) return;
    
    currentEditingFoodId = id;
    
    document.getElementById('edit-food-name').value = food.name;
    document.getElementById('edit-food-servings').value = food.servings;
    document.getElementById('edit-food-calories-per').value = food.caloriesPerServing;
    document.getElementById('edit-food-carbs-per').value = food.carbsPerServing;
    document.getElementById('edit-food-protein-per').value = food.proteinPerServing;
    document.getElementById('edit-food-fat-per').value = food.fatPerServing;
    
    recalculateFoodTotals();
    document.getElementById('edit-food-modal').classList.add('show');
}

function recalculateFoodFromServings() {
    recalculateFoodTotals();
}

function recalculateFoodTotals() {
    const servings = parseFloat(document.getElementById('edit-food-servings').value) || 1;
    const cals = parseFloat(document.getElementById('edit-food-calories-per').value) || 0;
    const carbs = parseFloat(document.getElementById('edit-food-carbs-per').value) || 0;
    const protein = parseFloat(document.getElementById('edit-food-protein-per').value) || 0;
    const fat = parseFloat(document.getElementById('edit-food-fat-per').value) || 0;
    
    const totalCals = Math.round(cals * servings);
    const totalCarbs = Math.round(carbs * servings * 10) / 10;
    const totalProtein = Math.round(protein * servings * 10) / 10;
    const totalFat = Math.round(fat * servings * 10) / 10;
    
    document.getElementById('food-total-servings').textContent = servings;
    document.getElementById('food-plural').textContent = servings === 1 ? '' : 's';
    document.getElementById('food-totals').textContent = `${totalCals} cal | C: ${totalCarbs}g | P: ${totalProtein}g | F: ${totalFat}g`;
}

function saveEditedFood() {
    if (!currentEditingFoodId) return;
    
    const food = foodLog.find(f => f.id === currentEditingFoodId);
    if (!food) return;
    
    const name = document.getElementById('edit-food-name').value;
    const servings = parseFloat(document.getElementById('edit-food-servings').value);
    const caloriesPerServing = parseFloat(document.getElementById('edit-food-calories-per').value);
    const carbsPerServing = parseFloat(document.getElementById('edit-food-carbs-per').value);
    const proteinPerServing = parseFloat(document.getElementById('edit-food-protein-per').value);
    const fatPerServing = parseFloat(document.getElementById('edit-food-fat-per').value);
    
    if (!name || isNaN(servings) || isNaN(caloriesPerServing) || isNaN(carbsPerServing) || isNaN(proteinPerServing) || isNaN(fatPerServing)) {
        alert('Please enter valid values');
        return;
    }
    
    food.name = name;
    food.servings = servings;
    food.caloriesPerServing = caloriesPerServing;
    food.carbsPerServing = carbsPerServing;
    food.proteinPerServing = proteinPerServing;
    food.fatPerServing = fatPerServing;
    food.calories = caloriesPerServing * servings;
    food.carbs = carbsPerServing * servings;
    food.protein = proteinPerServing * servings;
    food.fat = fatPerServing * servings;
    
    saveFoodLog();
    closeEditFoodModal();
    updateFoodLogDisplay();
    updateDashboard();
    alert('Food log entry updated!');
}

function closeEditFoodModal() {
    document.getElementById('edit-food-modal').classList.remove('show');
    currentEditingFoodId = null;
}

function saveFoodLog() {
    if (currentUser && firebaseInitialized) {
        saveToCloud();
    } else {
        localStorage.setItem('foodLog', JSON.stringify(foodLog));
    }
}

function loadFoodLog() {
    const saved = localStorage.getItem('foodLog');
    if (saved) foodLog = JSON.parse(saved);
    updateFoodLogDisplay();
}

function updateFoodLogDisplay() {
    const today = new Date().toISOString().split('T')[0];
    const todayFoods = foodLog.filter(food => food.date === today);
    const listElement = document.getElementById('food-log-list');
    const dashboardListElement = document.getElementById('today-food-list');
    
    if (todayFoods.length === 0) {
        const emptyMsg = '<p style="color: #999; text-align: center; padding: 20px;">No food logged today</p>';
        listElement.innerHTML = emptyMsg;
        dashboardListElement.innerHTML = emptyMsg;
        return;
    }
    
    const html = todayFoods.map(food => `
        <div class="food-log-item">
            <div>
                <h4>${food.name} ${food.servings !== 1 ? `<span style="color: #4CAF50; font-size: 14px;">(${food.servings} serving${food.servings !== 1 ? 's' : ''})</span>` : ''}</h4>
                <p>${Math.round(food.calories)} cal | C: ${Math.round(food.carbs * 10) / 10}g | P: ${Math.round(food.protein * 10) / 10}g | F: ${Math.round(food.fat * 10) / 10}g</p>
                <p style="font-size: 12px; color: #999;">${food.timestamp}</p>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm btn-secondary" onclick="editFood(${food.id})">Edit</button>
                <button class="delete-btn" onclick="deleteFood(${food.id})">Delete</button>
            </div>
        </div>
    `).join('');
    
    listElement.innerHTML = html;
    dashboardListElement.innerHTML = html;
}

function updateDashboard() {
    const today = new Date().toISOString().split('T')[0];
    const todayFoods = foodLog.filter(food => food.date === today);
    const todayMeals = assignedMeals.filter(meal => meal.date === today);
    
    // Calculate actual (eaten) macros
    let actualCalories = 0, actualCarbs = 0, actualProtein = 0, actualFat = 0;
    
    todayFoods.forEach(food => {
        actualCalories += food.calories;
        actualCarbs += food.carbs;
        actualProtein += food.protein;
        actualFat += food.fat;
    });
    
    todayMeals.filter(m => m.completed).forEach(meal => {
        const servings = meal.servings || 1;
        actualCalories += meal.calories * servings;
        actualCarbs += meal.carbs * servings;
        actualProtein += meal.protein * servings;
        actualFat += meal.fat * servings;
    });
    
    // Calculate planned (not yet eaten) macros
    let plannedCarbs = 0, plannedProtein = 0, plannedFat = 0;
    
    todayMeals.filter(m => !m.completed).forEach(meal => {
        const servings = meal.servings || 1;
        plannedCarbs += meal.carbs * servings;
        plannedProtein += meal.protein * servings;
        plannedFat += meal.fat * servings;
    });
    
    // Update calories progress bar (only actual eaten calories)
    const caloriesPercent = Math.min((actualCalories / userProfile.dailyCalories) * 100, 100);
    document.getElementById('calories-progress').style.width = caloriesPercent + '%';
    document.getElementById('calories-progress').textContent = Math.round(caloriesPercent) + '%';
    document.getElementById('calories-text').textContent = `${Math.round(actualCalories)} / ${userProfile.dailyCalories} cal`;
    
    // Update macros - show actual / planned
    document.getElementById('carbs-actual').textContent = Math.round(actualCarbs) + 'g';
    document.getElementById('carbs-planned').textContent = ' / ' + Math.round(plannedCarbs) + 'g';
    document.getElementById('carbs-goal').textContent = `Goal: ${userProfile.macros.carbs}g`;
    
    document.getElementById('protein-actual').textContent = Math.round(actualProtein) + 'g';
    document.getElementById('protein-planned').textContent = ' / ' + Math.round(plannedProtein) + 'g';
    document.getElementById('protein-goal').textContent = `Goal: ${userProfile.macros.protein}g`;
    
    document.getElementById('fat-actual').textContent = Math.round(actualFat) + 'g';
    document.getElementById('fat-planned').textContent = ' / ' + Math.round(actualFat) + 'g';
    document.getElementById('fat-goal').textContent = `Goal: ${userProfile.macros.fat}g`;
    
    displayTodayMeals();
    displayUpcomingMacros();
}

function displayUpcomingMacros() {
    const container = document.getElementById('upcoming-macros');
    const days = getNext7Days().slice(1, 4); // Next 3 days (skip today)
    
    if (days.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No upcoming meals planned</p>';
        return;
    }
    
    const html = days.map(day => {
        const dayMeals = assignedMeals.filter(meal => meal.date === day.date);
        
        if (dayMeals.length === 0) {
            return `
                <div class="upcoming-day-row" style="border-left-color: #ccc;">
                    <div class="upcoming-day-name">${day.label}</div>
                    <div style="color: #999; font-size: 14px;">No meals planned</div>
                </div>
            `;
        }
        
        let totalCarbs = 0, totalProtein = 0, totalFat = 0, totalCal = 0;
        dayMeals.forEach(meal => {
            const servings = meal.servings || 1;
            totalCarbs += meal.carbs * servings;
            totalProtein += meal.protein * servings;
            totalFat += meal.fat * servings;
            totalCal += meal.calories * servings;
        });
        
        return `
            <div class="upcoming-day-row">
                <div class="upcoming-day-name">${day.label}</div>
                <div class="upcoming-macros">
                    <div class="upcoming-macro-item">
                        <strong>${Math.round(totalCal)}</strong> cal
                    </div>
                    <div class="upcoming-macro-item" style="color: #FF9800;">
                        C: <strong>${Math.round(totalCarbs)}</strong>g
                    </div>
                    <div class="upcoming-macro-item" style="color: #2196F3;">
                        P: <strong>${Math.round(totalProtein)}</strong>g
                    </div>
                    <div class="upcoming-macro-item" style="color: #F44336;">
                        F: <strong>${Math.round(totalFat)}</strong>g
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function displayTodayMeals() {
    const today = new Date().toISOString().split('T')[0];
    const todayMeals = assignedMeals.filter(meal => meal.date === today);
    const container = document.getElementById('today-meals');
    
    if (todayMeals.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No meals planned today. Go to AI Meal Planner!</p>';
        return;
    }
    
    container.innerHTML = todayMeals.map(meal => {
        const servings = meal.servings || 1;
        const displayCals = Math.round(meal.calories * servings);
        const displayCarbs = Math.round(meal.carbs * servings * 10) / 10;
        const displayProtein = Math.round(meal.protein * servings * 10) / 10;
        const displayFat = Math.round(meal.fat * servings * 10) / 10;
        
        return `
        <div class="meal-card ${meal.completed ? 'completed' : ''}">
            <div class="meal-header">
                <div>
                    <h4>${meal.name}</h4>
                    <div class="meal-time">${meal.time || 'No time set'}</div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    ${!meal.completed ? `
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="number" class="serving-input" value="${servings}" step="0.1" min="0.1" 
                                onchange="updateMealServings(${meal.id}, this.value)">
                            <span class="serving-label">serving${servings !== 1 ? 's' : ''}</span>
                        </div>
                    ` : `
                        <span style="color: #666; font-size: 14px;">${servings} serving${servings !== 1 ? 's' : ''}</span>
                    `}
                    ${!meal.completed ? `<button class="btn btn-sm btn-secondary" onclick="editMeal(${meal.id})">Edit</button>` : ''}
                    ${!meal.completed ? `<button class="btn btn-sm btn-danger" onclick="deleteMeal(${meal.id})">Delete</button>` : ''}
                    <button class="btn btn-sm" onclick="${meal.completed ? 'void(0)' : 'confirmMeal(' + meal.id + ')'}" ${meal.completed ? 'disabled' : ''}>
                        ${meal.completed ? '‚úì Eaten at ' + meal.completedAt : 'Mark Eaten'}
                    </button>
                </div>
            </div>
            <p>${meal.description}</p>
            <p style="margin-top: 8px; color: #666;">${displayCals} cal | C: ${displayCarbs}g | P: ${displayProtein}g | F: ${displayFat}g</p>
        </div>
    `;
    }).join('');
}

function updateMealServings(mealId, servings) {
    const meal = assignedMeals.find(m => m.id === mealId);
    if (meal) {
        meal.servings = parseFloat(servings) || 1;
        saveMeals();
        updateDashboard();
        updateWeekView();
    }
}

function confirmMeal(id) {
    const meal = assignedMeals.find(m => m.id === id);
    if (meal) {
        meal.completed = true;
        meal.completedAt = new Date().toLocaleTimeString();
        meal.completedServings = meal.servings || 1; // Store the servings at time of completion
        saveMeals();
        updateDashboard();
        updateWeekView();
    }
}

function deleteMeal(id) {
    if (confirm('Remove this meal from your plan?')) {
        assignedMeals = assignedMeals.filter(m => m.id !== id);
        saveMeals();
        updateDashboard();
        updateWeekView();
    }
}

function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;
    addChatMessage(message, 'user');
    input.value = '';
    setTimeout(() => {
        generateMeals(message);
    }, 500);
}

function addChatMessage(message, type) {
    const container = document.getElementById('chat-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}`;
    if (type === 'assistant') {
        messageDiv.innerHTML = `<p><strong>AI:</strong> ${message}</p>`;
    } else {
        messageDiv.innerHTML = `<p><strong>You:</strong> ${message}</p>`;
    }
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function generateMeals(request) {
    const newMeals = [];
    const days = getNext7Days();
    
    // Sample meal options for each type
    const breakfastOptions = [
        { name: 'Scrambled Eggs & Toast', desc: '3 eggs, 2 whole wheat toast, spinach, avocado', ingredients: ['Eggs', 'Whole wheat bread', 'Spinach', 'Avocado'] },
        { name: 'Greek Yogurt Bowl', desc: 'Greek yogurt, berries, granola, honey, almonds', ingredients: ['Greek yogurt', 'Mixed berries', 'Granola', 'Honey', 'Almonds'] },
        { name: 'Oatmeal with Banana', desc: 'Steel cut oats, banana, peanut butter, cinnamon', ingredients: ['Steel cut oats', 'Banana', 'Peanut butter', 'Cinnamon'] },
        { name: 'Protein Pancakes', desc: 'Protein pancakes, berries, maple syrup', ingredients: ['Protein powder', 'Eggs', 'Oats', 'Berries', 'Maple syrup'] },
        { name: 'Veggie Omelet', desc: '3-egg omelet with peppers, onions, cheese, toast', ingredients: ['Eggs', 'Bell peppers', 'Onions', 'Cheese', 'Whole wheat bread'] },
        { name: 'Smoothie Bowl', desc: 'Protein smoothie bowl with banana, berries, granola', ingredients: ['Protein powder', 'Banana', 'Berries', 'Almond milk', 'Granola'] },
        { name: 'Breakfast Burrito', desc: 'Eggs, black beans, cheese, salsa in whole wheat tortilla', ingredients: ['Eggs', 'Black beans', 'Cheese', 'Salsa', 'Tortilla'] }
    ];
    
    const lunchOptions = [
        { name: 'Grilled Chicken Salad', desc: 'Grilled chicken breast, mixed greens, veggies, balsamic', ingredients: ['Chicken breast', 'Mixed greens', 'Tomatoes', 'Cucumber', 'Balsamic vinegar'] },
        { name: 'Turkey & Avocado Wrap', desc: 'Turkey, avocado, lettuce, tomato in whole wheat wrap', ingredients: ['Turkey breast', 'Avocado', 'Lettuce', 'Tomato', 'Whole wheat wrap'] },
        { name: 'Quinoa Buddha Bowl', desc: 'Quinoa, chickpeas, roasted veggies, tahini dressing', ingredients: ['Quinoa', 'Chickpeas', 'Broccoli', 'Sweet potato', 'Tahini'] },
        { name: 'Chicken & Rice Bowl', desc: 'Grilled chicken, brown rice, steamed vegetables', ingredients: ['Chicken breast', 'Brown rice', 'Broccoli', 'Carrots', 'Soy sauce'] },
        { name: 'Tuna Salad Sandwich', desc: 'Tuna salad on whole grain with lettuce and tomato', ingredients: ['Tuna', 'Whole grain bread', 'Lettuce', 'Tomato', 'Light mayo'] },
        { name: 'Chicken Fajita Bowl', desc: 'Chicken, peppers, onions, rice, black beans, salsa', ingredients: ['Chicken breast', 'Bell peppers', 'Onions', 'Rice', 'Black beans'] },
        { name: 'Greek Salad with Chicken', desc: 'Chicken, cucumber, tomatoes, feta, olives, olive oil', ingredients: ['Chicken breast', 'Cucumber', 'Tomatoes', 'Feta cheese', 'Olives'] }
    ];
    
    const dinnerOptions = [
        { name: 'Baked Salmon & Veggies', desc: 'Baked salmon, sweet potato, steamed broccoli', ingredients: ['Salmon', 'Sweet potato', 'Broccoli', 'Olive oil', 'Lemon'] },
        { name: 'Chicken Stir Fry', desc: 'Chicken, mixed vegetables, brown rice, teriyaki sauce', ingredients: ['Chicken breast', 'Mixed vegetables', 'Brown rice', 'Teriyaki sauce'] },
        { name: 'Lean Beef & Potatoes', desc: 'Lean ground beef, roasted potatoes, green beans', ingredients: ['Ground beef', 'Potatoes', 'Green beans', 'Garlic'] },
        { name: 'Turkey Meatballs & Pasta', desc: 'Turkey meatballs, whole wheat pasta, marinara sauce', ingredients: ['Ground turkey', 'Whole wheat pasta', 'Marinara sauce', 'Parmesan'] },
        { name: 'Grilled Chicken & Quinoa', desc: 'Grilled chicken, quinoa, roasted Brussels sprouts', ingredients: ['Chicken breast', 'Quinoa', 'Brussels sprouts', 'Olive oil'] },
        { name: 'Shrimp & Zucchini Noodles', desc: 'Grilled shrimp, zucchini noodles, garlic, olive oil', ingredients: ['Shrimp', 'Zucchini', 'Garlic', 'Olive oil', 'Lemon'] },
        { name: 'Pork Tenderloin & Asparagus', desc: 'Lean pork tenderloin, roasted asparagus, wild rice', ingredients: ['Pork tenderloin', 'Asparagus', 'Wild rice', 'Herbs'] }
    ];
    
    const snackOptions = [
        { name: 'Protein Shake', desc: 'Protein powder with almond milk and banana', ingredients: ['Protein powder', 'Almond milk', 'Banana'] },
        { name: 'Apple & Almond Butter', desc: 'Sliced apple with almond butter', ingredients: ['Apple', 'Almond butter'] },
        { name: 'Greek Yogurt & Berries', desc: 'Greek yogurt with mixed berries', ingredients: ['Greek yogurt', 'Mixed berries'] },
        { name: 'Protein Bar', desc: 'High-protein nutrition bar', ingredients: ['Protein bar'] },
        { name: 'Cottage Cheese & Fruit', desc: 'Cottage cheese with pineapple', ingredients: ['Cottage cheese', 'Pineapple'] },
        { name: 'Hummus & Veggies', desc: 'Hummus with carrot and celery sticks', ingredients: ['Hummus', 'Carrots', 'Celery'] },
        { name: 'Mixed Nuts', desc: 'Handful of mixed nuts (almonds, cashews, walnuts)', ingredients: ['Mixed nuts'] }
    ];
    
    // Generate meals distributed across the week
    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
        const suggestedDay = days[dayIndex];
        
        // Breakfast
        const breakfast = breakfastOptions[dayIndex % breakfastOptions.length];
        newMeals.push({
            id: Date.now() + (dayIndex * 4) + 0,
            name: breakfast.name,
            time: '7:00 AM',
            description: breakfast.desc,
            calories: Math.round(userProfile.dailyCalories * 0.25),
            carbs: Math.round(userProfile.macros.carbs * 0.25),
            protein: Math.round(userProfile.macros.protein * 0.25),
            fat: Math.round(userProfile.macros.fat * 0.25),
            ingredients: breakfast.ingredients,
            suggestedDay: suggestedDay.date,
            suggestedDayLabel: suggestedDay.label,
            servings: 1
        });
        
        // Lunch
        const lunch = lunchOptions[dayIndex % lunchOptions.length];
        newMeals.push({
            id: Date.now() + (dayIndex * 4) + 1,
            name: lunch.name,
            time: '12:00 PM',
            description: lunch.desc,
            calories: Math.round(userProfile.dailyCalories * 0.35),
            carbs: Math.round(userProfile.macros.carbs * 0.35),
            protein: Math.round(userProfile.macros.protein * 0.35),
            fat: Math.round(userProfile.macros.fat * 0.35),
            ingredients: lunch.ingredients,
            suggestedDay: suggestedDay.date,
            suggestedDayLabel: suggestedDay.label,
            servings: 1
        });
        
        // Dinner
        const dinner = dinnerOptions[dayIndex % dinnerOptions.length];
        newMeals.push({
            id: Date.now() + (dayIndex * 4) + 2,
            name: dinner.name,
            time: '6:30 PM',
            description: dinner.desc,
            calories: Math.round(userProfile.dailyCalories * 0.3),
            carbs: Math.round(userProfile.macros.carbs * 0.3),
            protein: Math.round(userProfile.macros.protein * 0.3),
            fat: Math.round(userProfile.macros.fat * 0.3),
            ingredients: dinner.ingredients,
            suggestedDay: suggestedDay.date,
            suggestedDayLabel: suggestedDay.label,
            servings: 1
        });
        
        // Snack
        const snack = snackOptions[dayIndex % snackOptions.length];
        newMeals.push({
            id: Date.now() + (dayIndex * 4) + 3,
            name: snack.name,
            time: '3:00 PM',
            description: snack.desc,
            calories: Math.round(userProfile.dailyCalories * 0.1),
            carbs: Math.round(userProfile.macros.carbs * 0.1),
            protein: Math.round(userProfile.macros.protein * 0.1),
            fat: Math.round(userProfile.macros.fat * 0.1),
            ingredients: snack.ingredients,
            suggestedDay: suggestedDay.date,
            suggestedDayLabel: suggestedDay.label,
            servings: 1
        });
    }
    
    generatedMeals.push(...newMeals);
    saveGeneratedMeals();
    updateGeneratedMealsDisplay();
    generateShoppingList();
    addChatMessage('Generated a week of delicious meals! Each meal shows what you\'ll be eating with real food descriptions. Days are pre-selected - just click "Quick Assign All" or individually assign/remove meals you don\'t want.', 'assistant');
}

function updateGeneratedMealsDisplay() {
    const section = document.getElementById('generated-meals-section');
    const container = document.getElementById('generated-meals-list');
    
    if (generatedMeals.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    container.innerHTML = generatedMeals.map(meal => `
        <div class="meal-card unassigned">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <h4>${meal.name}</h4>
                <span style="background: #E3F2FD; color: #1976D2; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                    ${meal.suggestedDayLabel}
                </span>
            </div>
            <p style="font-size: 13px; color: #666; margin-bottom: 4px;">${meal.time}</p>
            <p>${meal.description}</p>
            <p style="margin-top: 8px; color: #666;">${meal.calories} cal | C: ${meal.carbs}g | P: ${meal.protein}g | F: ${meal.fat}g</p>
            <div class="meal-actions" style="margin-top: 10px;">
                <select id="day-${meal.id}" class="input-group" style="flex: 1; padding: 8px;">
                    ${getNext7Days().map(day => 
                        `<option value="${day.date}" ${day.date === meal.suggestedDay ? 'selected' : ''}>${day.label}</option>`
                    ).join('')}
                </select>
                <button class="btn btn-sm" onclick="assignMealToDay(${meal.id})">Assign</button>
                <button class="btn btn-sm btn-danger" onclick="removeMeal(${meal.id})">Remove</button>
            </div>
        </div>
    `).join('');
}

function getNext7Days() {
    const days = [];
    for (let i = 0; i < 7; i++) {
        const date = new Date();
        date.setDate(date.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        const label = i === 0 ? 'Today' : i === 1 ? 'Tomorrow' : date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        days.push({ date: dateStr, label });
    }
    return days;
}

function assignMealToDay(mealId) {
    const meal = generatedMeals.find(m => m.id === mealId);
    const selectedDate = document.getElementById(`day-${mealId}`).value;
    
    if (!meal) return;
    
    assignedMeals.push({
        ...meal,
        date: selectedDate,
        completed: false,
        servings: 1
    });
    
    generatedMeals = generatedMeals.filter(m => m.id !== mealId);
    saveGeneratedMeals();
    saveMeals();
    updateGeneratedMealsDisplay();
    updateWeekView();
    updateDashboard();
}

function removeMeal(mealId) {
    if (confirm('Remove this meal?')) {
        generatedMeals = generatedMeals.filter(m => m.id !== mealId);
        saveGeneratedMeals();
        updateGeneratedMealsDisplay();
    }
}

function quickAssignAll() {
    if (generatedMeals.length === 0) return;
    
    if (confirm(`Assign all ${generatedMeals.length} meals to their suggested days?`)) {
        generatedMeals.forEach(meal => {
            assignedMeals.push({
                ...meal,
                date: meal.suggestedDay,
                completed: false,
                servings: 1
            });
        });
        
        generatedMeals = [];
        saveGeneratedMeals();
        saveMeals();
        updateGeneratedMealsDisplay();
        updateWeekView();
        updateDashboard();
        alert('All meals assigned! Check your Week View.');
    }
}

function clearGeneratedMeals() {
    if (confirm('Remove all generated meals?')) {
        generatedMeals = [];
        saveGeneratedMeals();
        updateGeneratedMealsDisplay();
    }
}

function editMeal(mealId) {
    const meal = assignedMeals.find(m => m.id === mealId);
    if (!meal) return;
    
    currentEditingMealId = mealId;
    
    // Populate modal with current values (base values, not multiplied by servings)
    document.getElementById('edit-meal-name').value = meal.name;
    document.getElementById('edit-servings').value = meal.servings || 1;
    document.getElementById('edit-carbs').value = meal.carbs;
    document.getElementById('edit-protein').value = meal.protein;
    document.getElementById('edit-fat').value = meal.fat;
    
    // Calculate and show calories
    recalculateCalories();
    
    // Show modal
    document.getElementById('edit-modal').classList.add('show');
}

function recalculateFromServings() {
    // Just recalculate the display - the base macros stay the same
    recalculateCalories();
}

function recalculateCalories() {
    const carbs = parseFloat(document.getElementById('edit-carbs').value) || 0;
    const protein = parseFloat(document.getElementById('edit-protein').value) || 0;
    const fat = parseFloat(document.getElementById('edit-fat').value) || 0;
    
    // Carbs: 4 cal/g, Protein: 4 cal/g, Fat: 9 cal/g
    const totalCalories = Math.round((carbs * 4) + (protein * 4) + (fat * 9));
    
    document.getElementById('edit-calories').value = totalCalories;
}

function closeEditModal() {
    document.getElementById('edit-modal').classList.remove('show');
    currentEditingMealId = null;
}

function saveEditedMeal() {
    if (!currentEditingMealId) return;
    
    const meal = assignedMeals.find(m => m.id === currentEditingMealId);
    if (!meal) return;
    
    const newServings = parseFloat(document.getElementById('edit-servings').value);
    const newCarbs = parseFloat(document.getElementById('edit-carbs').value);
    const newProtein = parseFloat(document.getElementById('edit-protein').value);
    const newFat = parseFloat(document.getElementById('edit-fat').value);
    const newCalories = parseFloat(document.getElementById('edit-calories').value); // Auto-calculated
    
    if (isNaN(newServings) || isNaN(newCarbs) || isNaN(newProtein) || isNaN(newFat)) {
        alert('Please enter valid numbers for all fields');
        return;
    }
    
    // Update the meal (store base values)
    meal.servings = newServings;
    meal.calories = newCalories;
    meal.carbs = newCarbs;
    meal.protein = newProtein;
    meal.fat = newFat;
    meal.edited = true;
    
    saveMeals();
    closeEditModal();
    updateDashboard();
    updateWeekView();
    alert('Meal updated! Calories recalculated. Now you can mark it as eaten.');
}

function updateWeekView() {
    const container = document.getElementById('week-calendar');
    const days = getNext7Days();
    
    container.innerHTML = days.map(day => {
        const dayMeals = assignedMeals.filter(m => m.date === day.date);
        return `
            <div class="day-column">
                <h4>${day.label}</h4>
                ${dayMeals.length === 0 ? '<p style="color: #999; font-size: 14px;">No meals planned</p>' : ''}
                ${dayMeals.map(meal => {
                    const servings = meal.servings || 1;
                    const displayCals = Math.round(meal.calories * servings);
                    const displayCarbs = Math.round(meal.carbs * servings * 10) / 10;
                    const displayProtein = Math.round(meal.protein * servings * 10) / 10;
                    const displayFat = Math.round(meal.fat * servings * 10) / 10;
                    
                    return `
                    <div class="meal-card ${meal.completed ? 'completed' : ''}" style="margin-bottom: 10px;">
                        <div style="margin-bottom: 8px;">
                            <strong style="display: block;">${meal.name}</strong>
                            <span style="font-size: 12px; color: #666;">${meal.time || ''}</span>
                        </div>
                        ${!meal.completed ? `
                            <div style="display: flex; align-items: center; gap: 6px; margin: 8px 0;">
                                <input type="number" class="serving-input" value="${servings}" step="0.1" min="0.1" 
                                    onchange="updateMealServings(${meal.id}, this.value)">
                                <span class="serving-label">serving${servings !== 1 ? 's' : ''}</span>
                            </div>
                        ` : `
                            <p style="font-size: 12px; color: #666; margin: 6px 0;">${servings} serving${servings !== 1 ? 's' : ''}</p>
                        `}
                        <p style="font-size: 13px; color: #666; margin: 6px 0;">${displayCals} cal | C: ${displayCarbs}g | P: ${displayProtein}g | F: ${displayFat}g</p>
                        <div style="display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap;">
                            ${!meal.completed ? `<button class="btn btn-sm btn-secondary" onclick="editMeal(${meal.id})" style="font-size: 12px; padding: 6px 12px;">Edit</button>` : ''}
                            ${!meal.completed ? `<button class="btn btn-sm btn-danger" onclick="deleteMeal(${meal.id})" style="font-size: 12px; padding: 6px 12px;">Delete</button>` : ''}
                            <button class="btn btn-sm" onclick="${meal.completed ? 'void(0)' : 'confirmMeal(' + meal.id + ')'}" ${meal.completed ? 'disabled' : ''} style="font-size: 12px; padding: 6px 12px;">
                                ${meal.completed ? '‚úì Eaten' : 'Mark Eaten'}
                            </button>
                        </div>
                    </div>
                `;
                }).join('')}
            </div>
        `;
    }).join('');
}

function showMealActions(mealId, event) {
    // This function is no longer needed but keeping for compatibility
    return;
}

function generateShoppingList() {
    const allIngredients = [];
    generatedMeals.forEach(meal => {
        meal.ingredients.forEach(ing => {
            if (!allIngredients.includes(ing)) {
                allIngredients.push(ing);
            }
        });
    });
    assignedMeals.forEach(meal => {
        meal.ingredients.forEach(ing => {
            if (!allIngredients.includes(ing)) {
                allIngredients.push(ing);
            }
        });
    });
    
    shoppingList = allIngredients.map(item => ({ item, checked: false }));
    saveShoppingList();
}

function displayShoppingList() {
    const container = document.getElementById('shopping-list-content');
    
    if (shoppingList.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Generate meals to see shopping list!</p>';
        return;
    }
    
    container.innerHTML = `
        <h3>Shopping List</h3>
        <ul style="list-style: none; padding: 0;">
            ${shoppingList.map((item, index) => `
                <li style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; ${item.checked ? 'text-decoration: line-through; opacity: 0.5;' : ''}">
                    <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleShoppingItem(${index})" style="width: 20px; height: 20px; cursor: pointer;">
                    <span>${item.item}</span>
                </li>
            `).join('')}
        </ul>
    `;
}

function toggleShoppingItem(index) {
    shoppingList[index].checked = !shoppingList[index].checked;
    saveShoppingList();
    displayShoppingList();
}

function clearShoppingList() {
    if (confirm('Clear shopping list?')) {
        shoppingList = [];
        saveShoppingList();
        displayShoppingList();
    }
}

function saveGeneratedMeals() {
    if (currentUser && firebaseInitialized) {
        saveToCloud();
    } else {
        localStorage.setItem('generatedMeals', JSON.stringify(generatedMeals));
    }
}

function saveMeals() {
    if (currentUser && firebaseInitialized) {
        saveToCloud();
    } else {
        localStorage.setItem('assignedMeals', JSON.stringify(assignedMeals));
    }
}

function loadMeals() {
    const savedGenerated = localStorage.getItem('generatedMeals');
    const savedAssigned = localStorage.getItem('assignedMeals');
    if (savedGenerated) generatedMeals = JSON.parse(savedGenerated);
    if (savedAssigned) assignedMeals = JSON.parse(savedAssigned);
    updateGeneratedMealsDisplay();
}

function saveShoppingList() {
    if (currentUser && firebaseInitialized) {
        saveToCloud();
    } else {
        localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
    }
}

function loadShoppingList() {
    const saved = localStorage.getItem('shoppingList');
    if (saved) shoppingList = JSON.parse(saved);
}
    </script>
</body>
</html>
